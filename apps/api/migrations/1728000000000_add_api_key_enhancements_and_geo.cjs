/**
 * @type {import('node-pg-migrate').ColumnDefinitions | undefined}
 */
const shorthands = undefined;

/**
 * @param pgm {import('node-pg-migrate').MigrationBuilder}
 * @param run {() => void | undefined}
 * @returns {Promise<void> | void}
 */
const up = (pgm) => {
  // Add name column to api_keys table
  pgm.sql(`ALTER TABLE api_keys ADD COLUMN IF NOT EXISTS name text;`);

  // Add table for country bounding boxes (min/max lat/lng for geo-validation)
  pgm.sql(`
    CREATE TABLE IF NOT EXISTS countries_bounding_boxes (
        country_code text PRIMARY KEY,
        min_lat double precision NOT NULL,
        max_lat double precision NOT NULL,
        min_lng double precision NOT NULL,
        max_lng double precision NOT NULL
    );
  `);

  // Sample data for major countries (extend with full GeoNames or external data)
  pgm.sql(`
        INSERT INTO countries_bounding_boxes (country_code, min_lat, max_lat, min_lng, max_lng, wraps_dateline) VALUES
            ('AD', 42.43447, 42.64273, 1.41484, 1.74023, false),
            ('AE', 22.62148, 26.06816, 51.56836, 56.38799, false),
            ('AF', 29.39194, 38.4564, 60.48574, 74.89131, false),
            ('AG', 16.99717, 17.71406, -61.88711, -61.68603, false),
            ('AI', 18.17139, 18.26973, -63.16001, -62.97959, false),
            ('AL', 39.65352, 42.64795, 19.28066, 21.03106, false),
            ('AM', 38.86904, 41.29097, 43.43945, 46.58477, false),
            ('AO', -18.01973, -4.42891, 11.74307, 24.04668, false),
            ('AQ', -89.99893, -60.5209, 0, -0.18457, true),
            ('AR', -55.03213, -21.80254, -73.57627, -53.66855, false),
            ('AS', -14.35977, -14.25742, -170.82051, -170.56811, false),
            ('AT', 46.39971, 49.00112, 9.52402, 17.14736, false),
            ('AU', -12.43594, -12.42393, 123.57246, 123.59522, false),
            ('AW', 12.423, 12.61411, -70.06611, -69.8957, false),
            ('AX', 60.01167, 60.40581, 19.51904, 20.61133, false),
            ('AZ', 38.39873, 41.89097, 44.76826, 50.36592, false),
            ('BA', 42.55972, 45.27656, 15.73662, 19.58379, false),
            ('BB', 13.06221, 13.31768, -59.64668, -59.42764, false),
            ('BD', 20.79043, 26.57153, 88.02344, 92.63164, false),
            ('BE', 49.51089, 51.49111, 2.5249, 6.36445, false),
            ('BF', 9.42471, 15.07788, -5.52353, 2.38916, false),
            ('BG', 41.24356, 44.23779, 22.34404, 28.58535, false),
            ('BH', 25.80679, 26.24644, 50.45244, 50.61748, false),
            ('BI', -4.45586, -2.31299, 29.01416, 30.81143, false),
            ('BJ', 6.2168, 12.38384, 0.76338, 3.83447, false),
            ('BL', 17.8752, 17.92227, -62.87544, -62.79971, false),
            ('BM', 32.25962, 32.38691, -64.86284, -64.66831, false),
            ('BN', 4.02398, 5.02236, 114.06387, 115.32676, false),
            ('BO', -22.8917, -9.71045, -69.6457, -57.49565, false),
            ('BR', -33.74219, 5.25796, -74.00205, -34.80547, false),
            ('BS', 20.9374, 26.94009, -78.98565, -72.74727, false),
            ('BT', 26.70156, 28.31118, 88.73877, 92.0834, false),
            ('BW', -26.8542, -17.7876, 19.97734, 29.36484, false),
            ('BY', 51.26504, 56.1458, 23.1751, 32.71025, false),
            ('BZ', 15.88867, 18.48232, -89.2375, -87.78862, false),
            ('CA', 41.67485, 83.11611, -141.00215, -52.65366, false),
            ('CD', -13.45381, 5.31211, 12.21367, 31.27402, false),
            ('CF', 2.27007, 10.99624, 14.43115, 27.40332, false),
            ('CG', -5.0043, 3.68731, 11.13018, 18.62217, false),
            ('CH', 45.83003, 47.77564, 5.97002, 10.45459, false),
            ('CI', 4.35132, 10.72407, -8.60356, -2.50586, false),
            ('CK', -21.24951, -21.18643, -159.84248, -159.73686, false),
            ('CL', -55.8917, -17.50605, -109.43413, -66.43579, false),
            ('CM', 1.67622, 13.07852, 8.53281, 16.1834, false),
            ('CN', 35.00034, 35.66206, 32.71269, 34.55606, false),
            ('CO', -4.23594, 12.43438, -79.02544, -66.87603, false),
            ('CR', 8.07065, 11.18945, -85.90801, -82.56357, false),
            ('CU', 19.85547, 23.19043, -84.88721, -74.13682, false),
            ('CV', 14.81821, 17.19365, -25.34155, -22.68189, false),
            ('CW', 12.04546, 12.38027, -69.15889, -68.75107, false),
            ('CY', 34.56958, 35.18267, 32.30098, 34.0502, false),
            ('CZ', 48.57622, 51.03779, 12.08975, 18.83223, false),
            ('DE', 47.27881, 55.05874, 5.85752, 15.0166, false),
            ('DJ', 10.94102, 12.70859, 41.76465, 43.40977, false),
            ('DK', 54.62886, 57.73691, 8.12148, 15.13711, false),
            ('DM', 15.2273, 15.63311, -61.48115, -61.25107, false),
            ('DO', 17.6356, 19.91397, -72.00039, -68.33916, false),
            ('DZ', 18.98662, 37.09238, -8.68335, 11.96787, false),
            ('EC', -4.99062, 1.45537, -91.65415, -75.24961, false),
            ('EE', 57.52549, 59.63901, 21.85449, 28.15107, false),
            ('EG', 21.99487, 31.65498, 24.70322, 36.87139, false),
            ('EH', 20.80615, 27.65645, -17.09878, -8.68213, false),
            ('ER', 12.37656, 18.00508, 36.42676, 43.1167, false),
            ('ES', 27.64639, 43.76455, -18.16055, 4.32207, false),
            ('ET', 3.4561, 14.8523, 32.99893, 47.97822, false),
            ('FI', 59.81602, 70.06484, 20.62217, 31.53652, false),
            ('FJ', -21.70586, -12.47695, 174.58721, -178.25112, true),
            ('FK', -52.30801, -51.26992, -61.14502, -57.7918, false),
            ('FM', 5.27725, 9.59331, 138.06191, 162.99346, false),
            ('FO', 61.41431, 62.35566, -7.42261, -6.40605, false),
            ('FR', -21.36904, 51.09712, -61.79409, 55.83906, false),
            ('GA', -3.91631, 2.3022, 8.70313, 14.48057, false),
            ('GB', 50.02139, 60.83189, -8.14482, 1.74658, false),
            ('GD', 12.00845, 12.23701, -61.78218, -61.60703, false),
            ('GE', 41.07021, 43.56978, 39.97832, 46.67256, false),
            ('GG', 49.42871, 49.50659, -2.64614, -2.51231, false),
            ('GH', 4.76245, 11.1669, -3.2439, 1.18721, false),
            ('GL', 59.81548, 83.59961, -72.81807, -11.42554, false),
            ('GM', 13.06416, 13.81211, -16.82481, -13.82671, false),
            ('GN', 7.21592, 12.67393, -15.05122, -7.6812, false),
            ('GQ', 0.96011, 3.7583, 8.43428, 11.33535, false),
            ('GR', 34.93447, 41.7438, 19.64648, 28.23184, false),
            ('GS', -58.49228, -53.98408, -38.01743, -26.25986, false),
            ('GT', 13.73652, 17.81641, -92.23516, -88.22832, false),
            ('GU', 13.25752, 13.62236, 144.64932, 144.94082, false),
            ('GW', 10.94014, 12.67993, -16.71182, -13.67354, false),
            ('GY', 1.20122, 8.54932, -61.39082, -56.48281, false),
            ('HK', 22.19517, 22.56499, 113.83887, 114.33525, false),
            ('HM', -53.18457, -52.96631, 73.25117, 73.83779, false),
            ('HN', 12.97925, 16.51397, -89.3626, -83.15752, false),
            ('HR', 42.43291, 46.53462, 13.51719, 19.40098, false),
            ('HT', 18.03916, 20.09365, -74.47812, -71.64531, false),
            ('HU', 45.75303, 48.55347, 16.09307, 22.87666, false),
            ('ID', -10.90967, 5.90703, 95.20664, 140.97617, false),
            ('IE', 51.47373, 55.36582, -10.39023, -6.02739, false),
            ('IL', 29.47734, 33.41567, 34.24531, 35.88798, false),
            ('IM', 54.05869, 54.40718, -4.78535, -4.33799, false),
            ('IN', 6.74868, 35.4959, 68.16504, 97.34356, false),
            ('IO', -7.43535, -7.22041, 72.34971, 72.49854, false),
            ('IQ', 29.06367, 37.37188, 38.77354, 48.54648, false),
            ('IR', 25.1021, 39.76856, 44.02324, 63.30518, false),
            ('IS', 63.40669, 66.52607, -24.47568, -13.5561, false),
            ('IT', 36.68784, 47.08213, 6.62773, 18.48584, false),
            ('JE', 49.16982, 49.26636, -2.23584, -2.00991, false),
            ('JM', 17.71494, 18.52222, -78.3395, -76.21079, false),
            ('JO', 29.19048, 33.37222, 34.95078, 39.29277, false),
            ('JP', 24.26606, 45.50952, 123.67979, 145.83301, false),
            ('KE', -4.69238, 5.49229, 33.9, 41.88398, false),
            ('KG', 39.20752, 43.24038, 69.2291, 80.24619, false),
            ('KH', 10.41123, 14.70508, 102.31973, 107.60547, false),
            ('KI', -11.45684, 3.92354, 169.52295, -151.78262, true),
            ('KM', -12.36826, -11.36846, 43.22666, 44.52676, false),
            ('KN', 17.10059, 17.40259, -62.84048, -62.53223, false),
            ('KP', 37.71904, 42.99815, 124.34863, 130.68731, false),
            ('KR', 33.20151, 38.62344, 126.00752, 130.93428, false),
            ('KW', 28.53315, 30.09731, 46.53145, 48.44248, false),
            ('KY', 19.27188, 19.76572, -81.41909, -79.74228, false),
            ('KZ', 40.60864, 55.3896, 46.60918, 87.32285, false),
            ('LA', 13.92119, 22.49526, 100.11494, 107.65313, false),
            ('LB', 33.07568, 34.67871, 35.10859, 36.58496, false),
            ('LC', 13.71758, 14.09336, -61.07315, -60.88677, false),
            ('LI', 47.05737, 47.27075, 9.47949, 9.61055, false),
            ('LK', 5.94937, 9.8127, 79.70781, 81.87695, false),
            ('LR', 4.35132, 8.53769, -11.50752, -7.3999, false),
            ('LS', -30.64228, -28.58174, 27.05176, 29.39072, false),
            ('LT', 53.89297, 56.41118, 20.89981, 26.77568, false),
            ('LU', 49.44546, 50.16719, 5.725, 6.49375, false),
            ('LV', 55.66753, 58.06343, 21.01494, 28.20205, false),
            ('LY', 19.49663, 33.18193, 9.31025, 25.15049, false),
            ('MA', 21.4207, 35.92988, -17.00308, -1.06553, false),
            ('MC', 43.73174, 43.7709, 7.37773, 7.43867, false),
            ('MD', 45.45044, 48.47773, 26.61895, 30.13106, false),
            ('ME', 41.86909, 43.54233, 18.43633, 20.34766, false),
            ('MF', 18.06895, 18.11533, -63.12305, -63.00942, false),
            ('MG', -25.57051, -12.07959, 43.25713, 50.48272, false),
            ('MH', 5.79981, 11.16865, 166.84473, 171.75684, false),
            ('MK', 40.8499, 42.35815, 20.44863, 23.00566, false),
            ('ML', 10.14326, 24.99561, -12.28061, 4.23467, false),
            ('MM', 9.87539, 28.51704, 92.17959, 101.14727, false),
            ('MN', 41.59551, 52.11729, 87.74316, 119.89785, false),
            ('MO', 22.19556, 22.24595, 113.47891, 113.54815, false),
            ('MP', 14.11133, 18.80679, 145.15215, 145.83545, false),
            ('MR', 14.74536, 27.28594, -17.06396, -4.82261, false),
            ('MS', 16.6812, 16.80957, -62.22305, -62.14844, false),
            ('MT', 35.82021, 36.07578, 14.18037, 14.56621, false),
            ('MU', -20.51318, -19.98994, 57.31768, 57.79199, false),
            ('MV', 3.2294, 4.24766, 73.38203, 73.52832, false),
            ('MW', -17.13105, -9.39502, 32.67041, 35.89277, false),
            ('MX', 14.54541, 32.71533, -118.40137, -86.69629, false),
            ('MY', 0.86196, 7.35166, 99.64629, 119.26631, false),
            ('MZ', -26.86162, -10.46435, 30.22178, 40.84453, false),
            ('NA', -28.93877, -16.96768, 11.72168, 25.25879, false),
            ('NC', -22.66113, -19.11465, 159.92822, 168.13906, false),
            ('NE', 11.69629, 23.51787, 0.16387, 15.96318, false),
            ('NF', -29.09629, -29.01396, 167.90615, 167.99043, false),
            ('NG', 4.27739, 13.87285, 2.68604, 14.62715, false),
            ('NI', 10.73535, 15.00806, -87.67017, -83.15752, false),
            ('NL', 12.03208, 53.62549, -68.37109, 7.19727, false),
            ('NO', 58.02095, 80.47783, -9.09888, 33.6293, false),
            ('NP', 26.3603, 30.3875, 80.05166, 88.16152, false),
            ('NR', -0.55078, -0.48935, 166.90703, 166.9584, false),
            ('NU', -19.13789, -18.96602, -169.94834, -169.79341, false),
            ('NZ', -52.57031, -8.54648, 165.88916, -171.18643, true),
            ('OM', 16.64839, 26.35635, 51.97764, 59.8375, false),
            ('PA', 7.22007, 9.59785, -83.02734, -77.196, false),
            ('PE', -18.3456, -0.04175, -81.33662, -68.68525, false),
            ('PF', -20.87588, -8.78154, -151.5124, -136.2939, false),
            ('PG', -11.63057, -1.35322, 140.86231, 155.95762, false),
            ('PH', 5.06021, 20.84126, 116.96953, 126.59336, false),
            ('PK', 23.75337, 37.03667, 60.84336, 77.04863, false),
            ('PL', 49.02075, 54.83818, 14.12861, 24.10576, false),
            ('PM', 46.75283, 47.09898, -56.38691, -56.13735, false),
            ('PN', -24.4126, -24.32324, -128.3502, -128.29009, false),
            ('PR', 17.94727, 18.52217, -67.93706, -65.29487, false),
            ('PS', 31.2083, 32.53442, 34.19814, 35.57207, false),
            ('PT', 32.64829, 42.1374, -31.28296, -6.2125, false),
            ('PW', 3.02188, 7.71211, 131.13496, 134.65957, false),
            ('PY', -27.55381, -19.28623, -62.65098, -54.2418, false),
            ('QA', 24.56465, 26.15327, 50.75459, 51.60889, false),
            ('RO', 43.6708, 48.26348, 20.2418, 29.70586, false),
            ('RS', 42.24214, 46.16919, 18.83906, 22.97686, false),
            ('RU', 41.19927, 81.8542, 19.6044, -169.72915, true),
            ('RW', -2.80859, -1.06309, 28.85762, 30.87656, false),
            ('SA', 16.37178, 32.12451, 34.61621, 55.64102, false),
            ('SB', -11.83223, -6.60889, 155.67754, 166.9292, false),
            ('SC', -4.78555, -4.55879, 55.3834, 55.54297, false),
            ('SD', 8.66563, 22.20244, 21.82529, 38.60947, false),
            ('SE', 55.34639, 69.03687, 11.14717, 24.15547, false),
            ('SG', 1.26538, 1.44707, 103.6502, 103.99639, false),
            ('SH', -16.004, -7.88262, -14.41494, -5.65972, false),
            ('SI', 45.42837, 46.86328, 13.37822, 16.51621, false),
            ('SK', 47.76343, 49.59771, 16.86269, 22.53867, false),
            ('SL', 6.90654, 9.99653, -13.29268, -10.2832, false),
            ('SM', 43.89409, 43.98975, 12.39688, 12.51465, false),
            ('SN', 12.32803, 16.67891, -17.53564, -11.38242, false),
            ('SO', -1.69531, 11.98369, 40.96445, 51.39023, false),
            ('SR', 1.84224, 5.99346, -58.05449, -53.99048, false),
            ('SS', 3.49072, 12.2231, 24.14736, 35.26836, false),
            ('ST', 0.04736, 1.69912, 6.46816, 7.45234, false),
            ('SV', 13.16401, 14.4311, -90.10591, -87.71533, false),
            ('SX', 18.01919, 18.06895, -63.12471, -63.01118, false),
            ('SY', 32.31729, 37.29727, 35.76445, 42.35908, false),
            ('SZ', -27.30996, -25.74297, 30.7875, 32.11289, false),
            ('TC', 21.75171, 21.9519, -72.34238, -71.63691, false),
            ('TD', 7.47529, 23.44522, 13.44824, 23.9834, false),
            ('TF', -49.70986, -46.32685, 51.65928, 70.55547, false),
            ('TG', 6.0894, 11.11563, -0.09019, 1.77793, false),
            ('TH', 5.63677, 20.42441, 97.37393, 105.64102, false),
            ('TJ', 36.68403, 41.03511, 67.34961, 75.11875, false),
            ('TL', -9.51191, -8.13994, 124.03633, 127.29609, false),
            ('TM', 35.1708, 42.77847, 52.49385, 66.6293, false),
            ('TN', 30.2294, 37.34038, 7.49561, 11.53594, false),
            ('TO', -21.45059, -18.56533, -175.36235, -173.92187, false),
            ('TR', 35.83145, 42.09326, 25.66895, 44.81719, false),
            ('TT', 10.06465, 11.32539, -61.9061, -60.52549, false),
            ('TV', -8.53496, -8.46631, 179.1957, 179.2166, false),
            ('TW', 21.925, 25.2769, 118.28731, 121.929, false),
            ('TZ', -11.71621, -0.99492, 29.32344, 40.46357, false),
            ('UA', 45.23413, 52.35356, 22.13184, 40.12832, false),
            ('UG', -1.46992, 4.22021, 29.56191, 34.97822, false),
            ('US', 18.96392, 71.40767, 172.49482, -66.98701, true),
            ('UY', -34.93281, -30.10107, -58.43813, -53.12559, false),
            ('UZ', 37.17222, 45.55537, 55.97568, 73.13691, false),
            ('VA', 41.89756, 41.9062, 12.42754, 12.43916, false),
            ('VC', 12.69473, 13.35874, -61.35352, -61.12402, false),
            ('VE', 0.68799, 12.17788, -73.36621, -59.82891, false),
            ('VG', 18.39912, 18.75269, -64.69512, -64.27358, false),
            ('VI', 17.70171, 18.38521, -65.02363, -64.58047, false),
            ('VN', 8.58325, 23.34522, 102.12744, 109.44492, false),
            ('VU', -20.2418, -13.70947, 166.52607, 169.89629, false),
            ('WF', -14.3249, -13.22168, -178.19438, -176.12808, false),
            ('WS', -14.04727, -13.46523, -172.77852, -171.44956, false),
            ('XK', 41.85381, 43.26108, 20.02949, 21.75293, false),
            ('YE', 12.31899, 18.99614, 42.54902, 54.51113, false),
            ('ZA', -46.96289, -22.14629, 16.44756, 37.8877, false),
            ('ZM', -18.0415, -8.19365, 21.97891, 33.66152, false),
            ('ZW', -22.40205, -15.64307, 25.22402, 33.00674, false)
        ON CONFLICT (country_code) DO UPDATE
        SET min_lat = excluded.min_lat,
            max_lat = excluded.max_lat,
            min_lng = excluded.min_lng,
            max_lng = excluded.max_lng,
            wraps_dateline = excluded.wraps_dateline;
  `);

  pgm.sql(`CREATE INDEX IF NOT EXISTS idx_bounding_country ON countries_bounding_boxes(country_code);`);

  // Add reason_counts to usage_daily for per-rule metrics
  pgm.sql(`ALTER TABLE usage_daily ADD COLUMN IF NOT EXISTS reason_counts jsonb DEFAULT '{}';`);

  // Trigger to update reason_counts on log insert
  pgm.sql(`
    CREATE OR REPLACE FUNCTION update_usage_reason_counts() RETURNS trigger AS $$
    DECLARE
        reason_counts_json jsonb;
    BEGIN
      -- Aggregate reason codes into JSONB object
      SELECT COALESCE(jsonb_object_agg(reason_code, count), '{}'::jsonb)
      INTO reason_counts_json
      FROM (
        SELECT unnest(NEW.reason_codes) as reason_code, COUNT(*) as count
        GROUP BY reason_code
      ) sub;

      -- Update usage_daily with aggregated reason code counts
      INSERT INTO usage_daily (project_id, date, validations, orders, reason_counts)
      VALUES (
        NEW.project_id,
        CURRENT_DATE,
        CASE WHEN NEW.type = 'validation' THEN 1 ELSE 0 END,
        CASE WHEN NEW.type = 'order' THEN 1 ELSE 0 END,
        reason_counts_json
      )
      ON CONFLICT (project_id, date) DO UPDATE SET
        validations = usage_daily.validations + EXCLUDED.validations,
        orders = usage_daily.orders + EXCLUDED.orders,
        reason_counts = usage_daily.reason_counts || EXCLUDED.reason_counts;

      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
  `);

  pgm.sql(`
    CREATE TRIGGER log_usage_trigger AFTER INSERT ON logs FOR EACH ROW EXECUTE FUNCTION update_usage_reason_counts();
  `);
};

/**
 * @param pgm {import('node-pg-migrate').MigrationBuilder}
 * @param run {() => void | undefined}
 * @returns {Promise<void> | void}
 */
const down = (pgm) => {
  pgm.sql(`DROP TRIGGER IF EXISTS log_usage_trigger ON logs;`);
  pgm.sql(`DROP FUNCTION IF EXISTS update_usage_reason_counts();`);
  pgm.sql(`ALTER TABLE usage_daily DROP COLUMN IF EXISTS reason_counts;`);
  pgm.sql(`DROP INDEX IF EXISTS idx_bounding_country;`);
  pgm.sql(`DROP TABLE IF EXISTS countries_bounding_boxes;`);
  pgm.sql(`ALTER TABLE api_keys DROP COLUMN IF EXISTS name;`);
};

module.exports = { shorthands, up, down };