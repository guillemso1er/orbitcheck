---
import Footer from '../components/Footer.astro';
import Head from '../components/Head.astro';
import AnnouncementBars from '../components/AnnouncementBars.astro';
import Header from '../components/Header.astro';
import '../styles/global.css';
---

<!doctype html>
<html lang="en">
  <Head />
  <body
    class="bg-gray-50 text-gray-900 antialiased dark:bg-gray-900 dark:text-gray-100"
  >
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Announcement Bars -->
    <AnnouncementBars />

    <!-- Header -->
    <Header />

    <!-- Main Content -->
    <main id="main-content">
      <slot />
    </main>

    <Footer />

    <!-- Scripts -->
    <script>
      // Update copyright year
      const copyrightYearEl = document.getElementById('copyright-year');
      if (copyrightYearEl) {
        copyrightYearEl.textContent = String(new Date().getFullYear());
      }

      // Mobile menu toggle
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      const menuIconOpen = document.getElementById('menu-icon-open');
      const menuIconClose = document.getElementById('menu-icon-close');

      mobileMenuButton?.addEventListener('click', () => {
        const isExpanded =
          mobileMenuButton?.getAttribute('aria-expanded') === 'true';
        mobileMenuButton?.setAttribute('aria-expanded', String(!isExpanded));
        mobileMenu?.classList.toggle('hidden');
        menuIconOpen?.classList.toggle('hidden');
        menuIconClose?.classList.toggle('hidden');
      });

      // Close mobile menu when clicking a link
      mobileMenu?.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', () => {
          mobileMenu?.classList.add('hidden');
          mobileMenuButton?.setAttribute('aria-expanded', 'false');
          menuIconOpen?.classList.remove('hidden');
          menuIconClose?.classList.add('hidden');
        });
      });

      // Theme toggle functionality
      function initTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleMobile = document.getElementById(
          'theme-toggle-mobile'
        );
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');

        function updateIcons() {
          const isDark = document.documentElement.classList.contains('dark');
          themeIconLight?.classList.toggle('hidden', isDark);
          themeIconDark?.classList.toggle('hidden', !isDark);
        }

        function toggleTheme() {
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          updateIcons();
        }

        themeToggle?.addEventListener('click', toggleTheme);
        themeToggleMobile?.addEventListener('click', toggleTheme);
        updateIcons();
      }

      initTheme();

      // Form progress tracking
      const roiForm = document.getElementById('roi-form');
      const progressBar = document.getElementById('form-progress-bar');
      const progressText = document.getElementById('form-progress-text');

      function updateFormProgress() {
        if (!roiForm) return;
        const inputs = roiForm.querySelectorAll(
          'input[required], select[required]'
        );
        const filledInputs = Array.from(inputs).filter((input: Element) => {
          const inputEl = input as HTMLInputElement;
          if (inputEl.type === 'checkbox') return inputEl.checked;
          return inputEl.value.trim() !== '';
        });
        const progress = Math.round(
          (filledInputs.length / inputs.length) * 100
        );
        if (progressBar) progressBar.style.width = `${progress}%`;
        if (progressText) progressText.textContent = `${progress}%`;
      }

      roiForm?.querySelectorAll('input, select').forEach((input) => {
        input.addEventListener('input', updateFormProgress);
        input.addEventListener('change', updateFormProgress);
      });

      // ROI Calculator
      const monthlyOrdersSelect = document.getElementById('roi-monthly-orders');
      const roiPreview = document.getElementById('roi-preview');
      const savingsAmount = document.getElementById('savings-amount');

      function updateROIEstimate() {
        const orders =
          parseInt((monthlyOrdersSelect as HTMLSelectElement)?.value || '0') ||
          0;
        if (orders > 0) {
          // Average order value $50, 3% failure rate, 40% recovery
          const avgOrderValue = 50;
          const failureRate = 0.03;
          const recoveryRate = 0.4;
          const savings = Math.round(
            orders * avgOrderValue * failureRate * recoveryRate
          );

          if (savingsAmount)
            savingsAmount.textContent = savings.toLocaleString();
          roiPreview?.classList.remove('hidden');
        } else {
          roiPreview?.classList.add('hidden');
        }
      }

      monthlyOrdersSelect?.addEventListener('change', updateROIEstimate);

      // Form submission
      roiForm?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = document.getElementById(
          'roi-submit-btn'
        ) as HTMLButtonElement | null;
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const notification = document.getElementById('roi-notification');
        const formContainer = document.getElementById('roi-form-container');
        const successMessage = document.getElementById('roi-success');

        // Disable button and show loading
        if (submitBtn) submitBtn.disabled = true;
        if (submitText) submitText.textContent = 'Sending...';
        if (submitSpinner) submitSpinner.classList.remove('hidden');

        const formData = new FormData(roiForm as HTMLFormElement);
        const ordersPerMonth =
          parseInt((formData.get('monthly_orders') as string) || '1000') ||
          1000;

        try {
          const response = await fetch(
            'https://api.orbitcheck.io/public/roi/estimate',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orders_per_month: ordersPerMonth }),
            }
          );

          if (response.ok) {
            // Show success
            if (roiForm) roiForm.classList.add('hidden');
            if (successMessage) successMessage.classList.remove('hidden');
          } else {
            throw new Error('Request failed');
          }
        } catch (error) {
          // Show error notification
          if (notification) {
            notification.className =
              'mt-4 p-4 rounded-lg border bg-red-50 text-red-800 border-red-200 dark:bg-red-900/20 dark:text-red-200 dark:border-red-800 toast';
            notification.textContent =
              'Something went wrong. Please try again or contact support@orbitcheck.io';
            notification.classList.remove('hidden');
          }

          if (submitBtn) submitBtn.disabled = false;
          if (submitText) submitText.textContent = 'Get Detailed ROI Report';
          if (submitSpinner) submitSpinner.classList.add('hidden');

          if (notification) {
            setTimeout(() => notification.classList.add('hidden'), 5000);
          }
        }
      });

      // Intersection Observer for animations
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px',
      };

      const animateOnScroll = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('animate');
            animateOnScroll.unobserve(entry.target);
          }
        });
      }, observerOptions);

      document.querySelectorAll('.count-up').forEach((el) => {
        animateOnScroll.observe(el);
      });

      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach((anchor: Element) => {
        const anchorEl = anchor as HTMLAnchorElement;
        anchorEl.addEventListener(
          'click',
          function (this: HTMLAnchorElement, e: Event) {
            const href = this.getAttribute('href');
            if (!href || href === '#') return;

            const target = document.querySelector(href);
            if (target) {
              e.preventDefault();
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });

              // Update URL without jumping
              history.pushState({}, '', href);
            }
          }
        );
      });

      // Keyboard navigation for FAQ
      document
        .querySelectorAll('details summary')
        .forEach((summary: Element) => {
          summary.addEventListener('keydown', (e: Event) => {
            const keyEvent = e as KeyboardEvent;
            if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
              e.preventDefault();
              (summary as HTMLElement).click();
            }
          });
        });
    </script>


  </body>
</html>
