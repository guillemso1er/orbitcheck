[Unit]
Description=My API
After=postgres.service valkey.service
Wants=postgres.service valkey.service

[Container]
LogDriver=journald
Image=ghcr.io/guillemso1er/api:prod
ContainerName=api
Pod=orbitcheck.pod

EnvironmentFile=/var/lib/containers/configs/api/api.env
EnvironmentFile=/var/lib/containers/configs/api/api.secrets.env

Volume=/var/lib/containers/volumes/api-data:/app/data:Z,U
Label="io.containers.autoupdate=image"
NoNewPrivileges=yes
ReadOnly=true
Tmpfs=/tmp:size=64M

[Service]
Restart=always
RestartSec=3

# Ensure env dir exists
ExecStartPre=/usr/bin/install -d -m 700 /var/lib/containers/configs/api/env

# Fetch secrets just-in-time, atomically, with strict perms
# Uses the service token from a local file (not shown in process args)
ExecStartPre=/bin/sh -ceu ' \
    tok="$(cat /home/podmanuser/.secrets/infisical/api.token)"; \
    export INFISICAL_TOKEN="$tok"; \
    /usr/local/bin/infisical export \
        --domain=https://infiscal.mydomain.com \
        --path=/api \
        --env=prod \
        --format=dotenv \
        --silent \
        --include-imports \
    > /var/lib/containers/configs/api/.api.secrets.env.tmp; \
    chmod 600 /var/lib/containers/configs/api/.api.secrets.env.tmp; \
    mv /var/lib/containers/configs/api/.api.secrets.env.tmp /var/lib/containers/configs/api/api.secrets.env \
'

# Keep your GHCR login if you need it (unrelated to Infisical)
ExecStartPre=-/bin/sh -c '/usr/bin/podman login ghcr.io -u guillemso1er --password-stdin < /run/secrets/ghcr_token'

[Install]
WantedBy=default.target