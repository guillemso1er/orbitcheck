# syntax=docker/dockerfile:1.7

ARG CADDY_VERSION=2.10.2

# Build Caddy with plugins (cached)
FROM caddy:${CADDY_VERSION}-builder AS caddy-builder
ENV GOTOOLCHAIN=auto
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg/mod \
    xcaddy build --with github.com/caddyserver/cache-handler@v0.16.0

# Final runtime image
FROM caddy:${CADDY_VERSION}-alpine

# Use the custom caddy binary
COPY --from=caddy-builder /usr/bin/caddy /usr/bin/caddy

# Copy your Caddyfile (adjust if you move it)
ARG CADDYFILE_PATH=infra/config/caddy/Caddyfile
COPY ${CADDYFILE_PATH} /etc/caddy/Caddyfile

# Copy prebuilt dashboard assets (artifact downloaded by the workflow)
COPY apps/dashboard/dist/ /usr/share/caddy/

WORKDIR /srv